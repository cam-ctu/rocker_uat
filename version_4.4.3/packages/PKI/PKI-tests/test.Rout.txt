
R version 4.4.3 (2025-02-28) -- "Trophy Case"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> ## simple test suite - avoid testthat! It has an insane amount of
> ## unnecessary dependencies. A test package should have exactly 0
> 
> assert <- function(msg, what) {
+     cat("   . ", msg,"\n")
+     stopifnot(what)
+     .GlobalEnv$ok <- .GlobalEnv$ok + 1L
+ }
> 
> xfail <- function(...) suppressWarnings(tryCatch({ ...; FALSE }, error=function(e) TRUE))
> 
> ## none of these are fatal
> info <- function(...) message(" -- ", ...)
> err  <- function(...) message(" ** ERROR: ", ...)
> warn <- function(...) message(" !! ", ...)
> 
> ## all warnings (unless suppressed) are errors
> options(warn=2)
> 
> library(PKI)
Loading required package: base64enc
> 
> .GlobalEnv$ok <- 0L
> 
> ## Majority of tests are in th3 examples,
> ## so we won't repeat those, but some special cases
> ## not covered there as well as expected failures
> 
> info("Checking failure paths")
 -- Checking failure paths
> xfail(PKI.load.cert(what="foo", file="bar")) ## set both what and file
[1] TRUE
> xfail(PKI.load.cert("foo", "DER")) ## binary format with text
[1] TRUE
> xfail(PKI.load.cert("nothing")) ## invalid content
[1] TRUE
> xfail(PKI.digest("foo", "bar")) ## invalid hash spec
[1] TRUE
> xfail(PKI.load.key(what="foo", file="bar"))
[1] TRUE
> xfail(PKI:::PKI.decode.SSH2(fn.priv.der)) ## try to load invalid content
[1] TRUE
> 
> info("Checking key paths via files/connections")
 -- Checking key paths via files/connections
> key <- PKI.genRSAkey(bits = 2048L)
> fn.priv.pem <- tempfile()
> PKI.save.key(key, target=fn.priv.pem)
 [1] "-----BEGIN RSA PRIVATE KEY-----"                                 
 [2] "MIIEpAIBAAKCAQEA6AJiSiYD2VYHzxTdZstX6P+M6lDVAm0zmeqcyvmA2B+Ec9jR"
 [3] "Js0c+VdCj6lUbUl4YDQzrydXqjPMDBHvXXUxeQ2zvqQqkR5UgAV8rZyaZr25JxSH"
 [4] "pMYvjitp1Kjt6HSKjXu8oDquP9M20SFgLn/f55Qx4m+ozrxLX3vgJ+/BeOnfon4s"
 [5] "pr2aEYYLZ0RplKF/aGFlpmXZD/WDswqjzIaO04aT/z/eFctsT6FUGZshyRqebxlT"
 [6] "nFpjvoCJi/Bln1eEFUZFuiV5rp2lKn+nW5SUCmcKQnxN0NCm2LHQakbhtZ5XsmKr"
 [7] "iANxkTGPgx5UNXDNcPNR3dHR1Q+bfkdVF4OH7wIDAQABAoIBABMufJvZcBYG6Sxe"
 [8] "HZPtxJM3QETwcTv7H/oIuJ/baE32BR24KPVGngT2CZhrt9bf7SY0YAA0232Z515+"
 [9] "w8XRS57Q2tyBzCHQBSJ0fFi04DBrB891q2VHHBAVV3GalIN/JyQIEpHuErv6JXJo"
[10] "NQCDLVWDHhYKL0WwXExE/JpbVdPo3HarJF9T/vfvgahYb7ibUE8hgFTRzUnsz8qk"
[11] "PWbK7LXFODsMxyzbeYp0u6TSY3aPdoTqZdefekWUMuUGBYCHonS1h0cX0hckRh0k"
[12] "NwxgYKkvPCjpmJey3iSpT67aLinTKecJrrvpA984CNR5m1u7KIbtLlhhwAzdwI3B"
[13] "9PA/eHkCgYEA+lUBFwMholKke11eC6iSpFjK6YtCS++c2qujCYrad3PgPRpAxspQ"
[14] "cU2vWLmyjaeUWR7BI4hmyYvws7GYdaBkuAO9QPN+BA41EHI5KJI95j2e0+Mlu232"
[15] "24PyGG11svZBwTrTNM+SS4XJIgsmVQyStiwBtbVz4vB/3aZfeywmXVsCgYEA7UMt"
[16] "B8oNCBSgsix68JcrVXj9NZ00HTYLMEaSjE0nUbjrHYIXog+OZV0miBjlDZr7+Zs0"
[17] "Ei9zMKEY/J3O7YdcHIOPCQ/VyMyBFw3/VRIoV/UCi9HMNW/2s35aHxKizRJsFPgf"
[18] "k/A4lqeUVWFNEKAEDK6WDFe8Q9hll9k0V76F3/0CgYEA76X5CSLCTDd5p3BW3Cph"
[19] "WFx4xOPAcBnPu7ecuUHoq3qPLW+4m5aLNCz+tJ3xxZKsfjTnCTFH1aLWp/BY2CLY"
[20] "ySErSMbR2OgQ/NGczq5R+9z59Db8pFY9gSDr317K0qzVfjrmfyRIFWzahHDQHZOP"
[21] "0D6I1IAFlThP8M2Zkr1NbQkCgYEA1PPESQd65tPM3964gZTNGiw76JEuo0FMjYnq"
[22] "Iu9k6R62OIf5OkYIIsaWvPTLMYj3vDMna2MXWoBdcu8ZOWySqi0Shqml0lJrUwwH"
[23] "Lo3blAaewGwPg674mGZB8T3CzZlJVRDXFus3f1Dt/CwXBWL5/3/7wRxGKAbkOISF"
[24] "THP+qOkCgYAJN/3LxrzdsecdlMF4p6Gow0lQz/hymbmGnjbAwBbBOqdYen5fSMAq"
[25] "chKtYJwuYrPzO98anHnni+Tkrq8gzRHzoSsJb/QXYEVBcVZ4WIXeaE1B7bsrFqEi"
[26] "RF0DUEl3lP5rVfwKFHxha7ONPTWsHBUeW6S3aeHQcuyt1UbWF6afzg=="        
[27] "-----END RSA PRIVATE KEY-----"                                   
> fn.priv.der <- tempfile()
> PKI.save.key(key, "DER", target=fn.priv.der)
   [1] 30 82 04 a4 02 01 00 02 82 01 01 00 e8 02 62 4a 26 03 d9 56 07 cf 14 dd
  [25] 66 cb 57 e8 ff 8c ea 50 d5 02 6d 33 99 ea 9c ca f9 80 d8 1f 84 73 d8 d1
  [49] 26 cd 1c f9 57 42 8f a9 54 6d 49 78 60 34 33 af 27 57 aa 33 cc 0c 11 ef
  [73] 5d 75 31 79 0d b3 be a4 2a 91 1e 54 80 05 7c ad 9c 9a 66 bd b9 27 14 87
  [97] a4 c6 2f 8e 2b 69 d4 a8 ed e8 74 8a 8d 7b bc a0 3a ae 3f d3 36 d1 21 60
 [121] 2e 7f df e7 94 31 e2 6f a8 ce bc 4b 5f 7b e0 27 ef c1 78 e9 df a2 7e 2c
 [145] a6 bd 9a 11 86 0b 67 44 69 94 a1 7f 68 61 65 a6 65 d9 0f f5 83 b3 0a a3
 [169] cc 86 8e d3 86 93 ff 3f de 15 cb 6c 4f a1 54 19 9b 21 c9 1a 9e 6f 19 53
 [193] 9c 5a 63 be 80 89 8b f0 65 9f 57 84 15 46 45 ba 25 79 ae 9d a5 2a 7f a7
 [217] 5b 94 94 0a 67 0a 42 7c 4d d0 d0 a6 d8 b1 d0 6a 46 e1 b5 9e 57 b2 62 ab
 [241] 88 03 71 91 31 8f 83 1e 54 35 70 cd 70 f3 51 dd d1 d1 d5 0f 9b 7e 47 55
 [265] 17 83 87 ef 02 03 01 00 01 02 82 01 00 13 2e 7c 9b d9 70 16 06 e9 2c 5e
 [289] 1d 93 ed c4 93 37 40 44 f0 71 3b fb 1f fa 08 b8 9f db 68 4d f6 05 1d b8
 [313] 28 f5 46 9e 04 f6 09 98 6b b7 d6 df ed 26 34 60 00 34 db 7d 99 e7 5e 7e
 [337] c3 c5 d1 4b 9e d0 da dc 81 cc 21 d0 05 22 74 7c 58 b4 e0 30 6b 07 cf 75
 [361] ab 65 47 1c 10 15 57 71 9a 94 83 7f 27 24 08 12 91 ee 12 bb fa 25 72 68
 [385] 35 00 83 2d 55 83 1e 16 0a 2f 45 b0 5c 4c 44 fc 9a 5b 55 d3 e8 dc 76 ab
 [409] 24 5f 53 fe f7 ef 81 a8 58 6f b8 9b 50 4f 21 80 54 d1 cd 49 ec cf ca a4
 [433] 3d 66 ca ec b5 c5 38 3b 0c c7 2c db 79 8a 74 bb a4 d2 63 76 8f 76 84 ea
 [457] 65 d7 9f 7a 45 94 32 e5 06 05 80 87 a2 74 b5 87 47 17 d2 17 24 46 1d 24
 [481] 37 0c 60 60 a9 2f 3c 28 e9 98 97 b2 de 24 a9 4f ae da 2e 29 d3 29 e7 09
 [505] ae bb e9 03 df 38 08 d4 79 9b 5b bb 28 86 ed 2e 58 61 c0 0c dd c0 8d c1
 [529] f4 f0 3f 78 79 02 81 81 00 fa 55 01 17 03 21 a2 52 a4 7b 5d 5e 0b a8 92
 [553] a4 58 ca e9 8b 42 4b ef 9c da ab a3 09 8a da 77 73 e0 3d 1a 40 c6 ca 50
 [577] 71 4d af 58 b9 b2 8d a7 94 59 1e c1 23 88 66 c9 8b f0 b3 b1 98 75 a0 64
 [601] b8 03 bd 40 f3 7e 04 0e 35 10 72 39 28 92 3d e6 3d 9e d3 e3 25 bb 6d f6
 [625] db 83 f2 18 6d 75 b2 f6 41 c1 3a d3 34 cf 92 4b 85 c9 22 0b 26 55 0c 92
 [649] b6 2c 01 b5 b5 73 e2 f0 7f dd a6 5f 7b 2c 26 5d 5b 02 81 81 00 ed 43 2d
 [673] 07 ca 0d 08 14 a0 b2 2c 7a f0 97 2b 55 78 fd 35 9d 34 1d 36 0b 30 46 92
 [697] 8c 4d 27 51 b8 eb 1d 82 17 a2 0f 8e 65 5d 26 88 18 e5 0d 9a fb f9 9b 34
 [721] 12 2f 73 30 a1 18 fc 9d ce ed 87 5c 1c 83 8f 09 0f d5 c8 cc 81 17 0d ff
 [745] 55 12 28 57 f5 02 8b d1 cc 35 6f f6 b3 7e 5a 1f 12 a2 cd 12 6c 14 f8 1f
 [769] 93 f0 38 96 a7 94 55 61 4d 10 a0 04 0c ae 96 0c 57 bc 43 d8 65 97 d9 34
 [793] 57 be 85 df fd 02 81 81 00 ef a5 f9 09 22 c2 4c 37 79 a7 70 56 dc 2a 61
 [817] 58 5c 78 c4 e3 c0 70 19 cf bb b7 9c b9 41 e8 ab 7a 8f 2d 6f b8 9b 96 8b
 [841] 34 2c fe b4 9d f1 c5 92 ac 7e 34 e7 09 31 47 d5 a2 d6 a7 f0 58 d8 22 d8
 [865] c9 21 2b 48 c6 d1 d8 e8 10 fc d1 9c ce ae 51 fb dc f9 f4 36 fc a4 56 3d
 [889] 81 20 eb df 5e ca d2 ac d5 7e 3a e6 7f 24 48 15 6c da 84 70 d0 1d 93 8f
 [913] d0 3e 88 d4 80 05 95 38 4f f0 cd 99 92 bd 4d 6d 09 02 81 81 00 d4 f3 c4
 [937] 49 07 7a e6 d3 cc df de b8 81 94 cd 1a 2c 3b e8 91 2e a3 41 4c 8d 89 ea
 [961] 22 ef 64 e9 1e b6 38 87 f9 3a 46 08 22 c6 96 bc f4 cb 31 88 f7 bc 33 27
 [985] 6b 63 17 5a 80 5d 72 ef 19 39 6c 92 aa 2d 12 86 a9 a5 d2 52 6b 53 0c 07
[1009] 2e 8d db 94 06 9e c0 6c 0f 83 ae f8 98 66 41 f1 3d c2 cd 99 49 55 10 d7
[1033] 16 eb 37 7f 50 ed fc 2c 17 05 62 f9 ff 7f fb c1 1c 46 28 06 e4 38 84 85
[1057] 4c 73 fe a8 e9 02 81 80 09 37 fd cb c6 bc dd b1 e7 1d 94 c1 78 a7 a1 a8
[1081] c3 49 50 cf f8 72 99 b9 86 9e 36 c0 c0 16 c1 3a a7 58 7a 7e 5f 48 c0 2a
[1105] 72 12 ad 60 9c 2e 62 b3 f3 3b df 1a 9c 79 e7 8b e4 e4 ae af 20 cd 11 f3
[1129] a1 2b 09 6f f4 17 60 45 41 71 56 78 58 85 de 68 4d 41 ed bb 2b 16 a1 22
[1153] 44 5d 03 50 49 77 94 fe 6b 55 fc 0a 14 7c 61 6b b3 8d 3d 35 ac 1c 15 1e
[1177] 5b a4 b7 69 e1 d0 72 ec ad d5 46 d6 17 a6 9f ce
attr(,"class")
[1] "private.key.DER"
> PKI.load.key(file=fn.priv.pem)
<pointer: 0x55707a2c46e0>
attr(,"class")
[1] "private.key"
> PKI.load.key(file=fn.priv.der, format="DER", private=TRUE)
<pointer: 0x55707a2bdf50>
attr(,"class")
[1] "private.key"
> fn.pub.pem <- tempfile()
> PKI.save.key(key, target=fn.pub.pem, private=FALSE)
[1] "-----BEGIN PUBLIC KEY-----"                                      
[2] "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA6AJiSiYD2VYHzxTdZstX"
[3] "6P+M6lDVAm0zmeqcyvmA2B+Ec9jRJs0c+VdCj6lUbUl4YDQzrydXqjPMDBHvXXUx"
[4] "eQ2zvqQqkR5UgAV8rZyaZr25JxSHpMYvjitp1Kjt6HSKjXu8oDquP9M20SFgLn/f"
[5] "55Qx4m+ozrxLX3vgJ+/BeOnfon4spr2aEYYLZ0RplKF/aGFlpmXZD/WDswqjzIaO"
[6] "04aT/z/eFctsT6FUGZshyRqebxlTnFpjvoCJi/Bln1eEFUZFuiV5rp2lKn+nW5SU"
[7] "CmcKQnxN0NCm2LHQakbhtZ5XsmKriANxkTGPgx5UNXDNcPNR3dHR1Q+bfkdVF4OH"
[8] "7wIDAQAB"                                                        
[9] "-----END PUBLIC KEY-----"                                        
> fn.pub.der <- tempfile()
> PKI.save.key(key, "DER", target=fn.pub.der, private=FALSE)
  [1] 30 82 01 22 30 0d 06 09 2a 86 48 86 f7 0d 01 01 01 05 00 03 82 01 0f 00 30
 [26] 82 01 0a 02 82 01 01 00 e8 02 62 4a 26 03 d9 56 07 cf 14 dd 66 cb 57 e8 ff
 [51] 8c ea 50 d5 02 6d 33 99 ea 9c ca f9 80 d8 1f 84 73 d8 d1 26 cd 1c f9 57 42
 [76] 8f a9 54 6d 49 78 60 34 33 af 27 57 aa 33 cc 0c 11 ef 5d 75 31 79 0d b3 be
[101] a4 2a 91 1e 54 80 05 7c ad 9c 9a 66 bd b9 27 14 87 a4 c6 2f 8e 2b 69 d4 a8
[126] ed e8 74 8a 8d 7b bc a0 3a ae 3f d3 36 d1 21 60 2e 7f df e7 94 31 e2 6f a8
[151] ce bc 4b 5f 7b e0 27 ef c1 78 e9 df a2 7e 2c a6 bd 9a 11 86 0b 67 44 69 94
[176] a1 7f 68 61 65 a6 65 d9 0f f5 83 b3 0a a3 cc 86 8e d3 86 93 ff 3f de 15 cb
[201] 6c 4f a1 54 19 9b 21 c9 1a 9e 6f 19 53 9c 5a 63 be 80 89 8b f0 65 9f 57 84
[226] 15 46 45 ba 25 79 ae 9d a5 2a 7f a7 5b 94 94 0a 67 0a 42 7c 4d d0 d0 a6 d8
[251] b1 d0 6a 46 e1 b5 9e 57 b2 62 ab 88 03 71 91 31 8f 83 1e 54 35 70 cd 70 f3
[276] 51 dd d1 d1 d5 0f 9b 7e 47 55 17 83 87 ef 02 03 01 00 01
attr(,"class")
[1] "public.key.DER"
> PKI.load.key(file=fn.pub.pem)
<pointer: 0x55707a22a970>
attr(,"class")
[1] "public.key"
> PKI.load.key(file=fn.pub.der, format="DER", private=FALSE)
<pointer: 0x55707a22c380>
attr(,"class")
[1] "public.key"
> 
> info("gmp")
 -- gmp
> if (requireNamespace("gmp", quietly=TRUE)) {
+     PKI.mkRSApubkey(gmp::as.bigz("119445732379544598056145200053932732877863846799652384989588303737527328743970559883211146487286317168142202446955508902936035124709397221178664495721428029984726868375359168203283442617134197706515425366188396513684446494070223079865755643116690165578452542158755074958452695530623055205290232290667934914919"))
+ } else {
+     warn("gmp not found, skipping bignum tests")
+ }
  [1] 30 81 9f 30 0d 06 09 2a 86 48 86 f7 0d 01 01 01 05 00 03 81 8d 00 30 81 89
 [26] 02 81 81 00 aa 18 ab a4 3b 50 de ef 38 59 8f af 87 d2 ab 63 4e 45 71 c1 30
 [51] a9 bc a7 b8 78 26 74 14 fa ab 8b 47 1b d8 96 5f 5c 9f c3 81 84 85 ea f5 29
 [76] c2 62 46 f3 05 50 64 a8 de 19 c8 c3 38 be 54 96 cb ae b0 59 dc 0b 35 81 43
[101] b4 4a 35 44 9e b2 64 11 31 21 a4 55 bd 7f de 3f ac 91 9e 94 b5 6f b9 bb 4f
[126] 65 1c db 23 ea d4 39 d6 cd 52 3e b0 81 91 e7 5b 35 fd 13 a7 41 9b 30 90 f2
[151] 47 87 bd 4f 4e 19 67 02 03 01 00 01
> 
> info("Ciphers")
 -- Ciphers
> skey <- PKI.random(256)
> for (cipher in c("aes256ecb", "aes256ofb", "bfcbc", "bfecb", "bfofb", "bfcfb"))
+     assert(cipher, all(PKI.decrypt(PKI.encrypt(charToRaw("foo!"), skey, cipher), skey, cipher)[1:4] == charToRaw("foo!")))
   .  aes256ecb 
   .  aes256ofb 
   .  bfcbc 
   .  bfecb 
   .  bfofb 
   .  bfcfb 
> iv <- PKI.random(256)
> for (cipher in c("bfcbc", "bfecb", "bfofb", "bfcfb"))
+     assert(paste0(cipher, " (with IV)"),
+                   all(PKI.decrypt(PKI.encrypt(charToRaw("foo!"), skey, cipher, iv=iv), skey, cipher, iv=iv)[1:4] == charToRaw("foo!")))
   .  bfcbc (with IV) 
   .  bfecb (with IV) 
   .  bfofb (with IV) 
   .  bfcfb (with IV) 
> 
> info("ASN.1")
 -- ASN.1
> 
> assert("ASN.1 encode/decode", 
+ { d <- ASN1.decode(ASN1.encode(ASN1.item(0:255, 3L)))
+   ASN1.type(d) == 3L && all(d == as.raw(0:255)) })
   .  ASN.1 encode/decode 
> 
> info("Tar ball signing")
 -- Tar ball signing
> tmpfn <- c(fn.pub.der, fn.pub.pem, fn.priv.der, fn.priv.pem)
> fn <- tempfile()
> ## on some systems using abs paths can break 100 byte limit
> ## so we must do this in the tempdir
> wd <- getwd()
> td <- tempdir()
> setwd(td)
> tar(fn, basename(tmpfn), "none")
> PKI.sign.tar(fn, key)
> PKI.verify.tar(fn, key)
[1] TRUE
> setwd(wd)
> 
> unlink(c(fn, tmpfn))
> 
