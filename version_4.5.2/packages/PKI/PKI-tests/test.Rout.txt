
R version 4.5.2 (2025-10-31) -- "[Not] Part in a Rumble"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> ## simple test suite - avoid testthat! It has an insane amount of
> ## unnecessary dependencies. A test package should have exactly 0
> 
> assert <- function(msg, what) {
+     cat("   . ", msg,"\n")
+     stopifnot(what)
+     .GlobalEnv$ok <- .GlobalEnv$ok + 1L
+ }
> 
> xfail <- function(...) suppressWarnings(tryCatch({ ...; FALSE }, error=function(e) TRUE))
> 
> ## none of these are fatal
> info <- function(...) message(" -- ", ...)
> err  <- function(...) message(" ** ERROR: ", ...)
> warn <- function(...) message(" !! ", ...)
> 
> ## all warnings (unless suppressed) are errors
> options(warn=2)
> 
> library(PKI)
Loading required package: base64enc
> 
> .GlobalEnv$ok <- 0L
> 
> ## Majority of tests are in th3 examples,
> ## so we won't repeat those, but some special cases
> ## not covered there as well as expected failures
> 
> info("Checking failure paths")
 -- Checking failure paths
> xfail(PKI.load.cert(what="foo", file="bar")) ## set both what and file
[1] TRUE
> xfail(PKI.load.cert("foo", "DER")) ## binary format with text
[1] TRUE
> xfail(PKI.load.cert("nothing")) ## invalid content
[1] TRUE
> xfail(PKI.digest("foo", "bar")) ## invalid hash spec
[1] TRUE
> xfail(PKI.load.key(what="foo", file="bar"))
[1] TRUE
> xfail(PKI:::PKI.decode.SSH2(fn.priv.der)) ## try to load invalid content
[1] TRUE
> 
> info("Checking key paths via files/connections")
 -- Checking key paths via files/connections
> key <- PKI.genRSAkey(bits = 2048L)
> fn.priv.pem <- tempfile()
> PKI.save.key(key, target=fn.priv.pem)
 [1] "-----BEGIN RSA PRIVATE KEY-----"                                 
 [2] "MIIEogIBAAKCAQEApFknwSPCtZLUaxcgR82GcUVnKMjuukO55XankPurINXqHPJo"
 [3] "v5KBJSI39sJckHZTmiT3mil3QXl/gEAxmSxrcFnu9AbmdIzCLbl/L6R2r69X0BX6"
 [4] "qyciGj6nahNlFEHCQAJwgTq9NpuGvlSrTVEQVIOdbw2CfEMloHO4OrwKyn/h+3LN"
 [5] "1eFikBrd+vbWxB66JqZMoSA/ZyXLvZzssOTvUfj3t6iyWesnFYGODEwGB/T6DmW8"
 [6] "jTIljoDTXtEt0KsHCymzNk3tm1ejNPEdFp0mgNbxG0oJj/zAJ6iX1SpE0eGkIkRE"
 [7] "HGXubLWJ76cGOzlBL/rxtGf4SSdS+vFjZLXF+wIDAQABAoIBAEwXJRNEYcUcTnGo"
 [8] "et8Tll/CIMFeyjx918cX+PvksTXaJHKzfvDXPSi6n4uFMEMILavL2sFK2nZ7cJ8p"
 [9] "2WzQBow1by8XNMKYWty9qdeefv7XIUJrsqtkSmM5R9ySTzWiPnPRTVJfpjPurONZ"
[10] "IxiAZB2k9BJzAEtU8UpI2W6EGkDnVt+6CBOmEU2/KH21yFTAW/yHo59+UXxBcS0K"
[11] "NRIUCr3a//pMkNtn4Jo3CfHbrYYIrCk05NcfTZU3VR4V3i9lsACiJ/3p6z1GQ5CD"
[12] "kFtA8cV3Opet20rplu/9f1yUITkHx1UchPh6MEPhM/lrWtcorBSFvccmtA8TFGkv"
[13] "XMB2tJECgYEA3qkG9w/14RSMF8e6wGsnpunxhiF6GPyZgVnL+4AKUiy6D2n3zDaE"
[14] "qbsjWzLZwyjD9ka61rdfd+La57DqaDJEf2N7QIP6Y+43SqPVu+FTXZnA5GrsAJYD"
[15] "4pZR3oVdw2J7oqzNHJoYd8erjTmeVu7wL12wx3AMyz1aWr9HmT4RupECgYEAvPTs"
[16] "T5xWQFIqgtCZev4JsZEnxULw5d9YrGyFGur6SbROTVrx99XMiQVGegQ2ZtDhcZSJ"
[17] "8C7f2Mq6AIpefahBieaYSphKW2bgJESF606DKROxTpQbpPuinX3/Wff4OlXJs+pL"
[18] "QpVZCXgcuQdBFpRc2jYigjT2hl3LacSGsCDiBcsCgYAczcTm5RuruFq/IMlZ5wLE"
[19] "JvNlpKME5Hh/MTygFlo/cyXGpLC3rD3RLzJNs/BTvMxM6a115VbmTWSAIHTScd5G"
[20] "lHn3SJt1nfVtJHCb03RTYXaAlgxdrwpln4iLvrj4c58G1k/aaVzM8fmRVWjUWiic"
[21] "GASsaCRfjlpH7wK2Ij9s4QKBgDZ48Qr+ScsfJMwzcJuJUqgS7YErjCDoozqJylF5"
[22] "PhAzX4NjXXAR/XXexHN2dWxseSFyLdXE3Zk00CxJt3XIJKSpimuuvXjeDm3GJ0kv"
[23] "iBY2bB34CoQkWrvGT+/S0YeXpZ8tQub+AP3+12Dr23Kz8JSjmI0q0YrozTQ/iIiL"
[24] "4jzDAoGARuwP64fDqG7q/Jrj1ZWqWTUlVmanqYa2/9edcXY0q2ekjetuVmGoup9w"
[25] "92b912Pi8iOvIxVf+OvyGaRHNzxClzUUU6ImVAD6LAjsyVJ4irXFjrm85j66j3gC"
[26] "i481UYFfjkss9tmS2Nc3IXs912tn+2h9vAPSiwjtimXliN22Fec="            
[27] "-----END RSA PRIVATE KEY-----"                                   
> fn.priv.der <- tempfile()
> PKI.save.key(key, "DER", target=fn.priv.der)
   [1] 30 82 04 a2 02 01 00 02 82 01 01 00 a4 59 27 c1 23 c2 b5 92 d4 6b 17 20
  [25] 47 cd 86 71 45 67 28 c8 ee ba 43 b9 e5 76 a7 90 fb ab 20 d5 ea 1c f2 68
  [49] bf 92 81 25 22 37 f6 c2 5c 90 76 53 9a 24 f7 9a 29 77 41 79 7f 80 40 31
  [73] 99 2c 6b 70 59 ee f4 06 e6 74 8c c2 2d b9 7f 2f a4 76 af af 57 d0 15 fa
  [97] ab 27 22 1a 3e a7 6a 13 65 14 41 c2 40 02 70 81 3a bd 36 9b 86 be 54 ab
 [121] 4d 51 10 54 83 9d 6f 0d 82 7c 43 25 a0 73 b8 3a bc 0a ca 7f e1 fb 72 cd
 [145] d5 e1 62 90 1a dd fa f6 d6 c4 1e ba 26 a6 4c a1 20 3f 67 25 cb bd 9c ec
 [169] b0 e4 ef 51 f8 f7 b7 a8 b2 59 eb 27 15 81 8e 0c 4c 06 07 f4 fa 0e 65 bc
 [193] 8d 32 25 8e 80 d3 5e d1 2d d0 ab 07 0b 29 b3 36 4d ed 9b 57 a3 34 f1 1d
 [217] 16 9d 26 80 d6 f1 1b 4a 09 8f fc c0 27 a8 97 d5 2a 44 d1 e1 a4 22 44 44
 [241] 1c 65 ee 6c b5 89 ef a7 06 3b 39 41 2f fa f1 b4 67 f8 49 27 52 fa f1 63
 [265] 64 b5 c5 fb 02 03 01 00 01 02 82 01 00 4c 17 25 13 44 61 c5 1c 4e 71 a8
 [289] 7a df 13 96 5f c2 20 c1 5e ca 3c 7d d7 c7 17 f8 fb e4 b1 35 da 24 72 b3
 [313] 7e f0 d7 3d 28 ba 9f 8b 85 30 43 08 2d ab cb da c1 4a da 76 7b 70 9f 29
 [337] d9 6c d0 06 8c 35 6f 2f 17 34 c2 98 5a dc bd a9 d7 9e 7e fe d7 21 42 6b
 [361] b2 ab 64 4a 63 39 47 dc 92 4f 35 a2 3e 73 d1 4d 52 5f a6 33 ee ac e3 59
 [385] 23 18 80 64 1d a4 f4 12 73 00 4b 54 f1 4a 48 d9 6e 84 1a 40 e7 56 df ba
 [409] 08 13 a6 11 4d bf 28 7d b5 c8 54 c0 5b fc 87 a3 9f 7e 51 7c 41 71 2d 0a
 [433] 35 12 14 0a bd da ff fa 4c 90 db 67 e0 9a 37 09 f1 db ad 86 08 ac 29 34
 [457] e4 d7 1f 4d 95 37 55 1e 15 de 2f 65 b0 00 a2 27 fd e9 eb 3d 46 43 90 83
 [481] 90 5b 40 f1 c5 77 3a 97 ad db 4a e9 96 ef fd 7f 5c 94 21 39 07 c7 55 1c
 [505] 84 f8 7a 30 43 e1 33 f9 6b 5a d7 28 ac 14 85 bd c7 26 b4 0f 13 14 69 2f
 [529] 5c c0 76 b4 91 02 81 81 00 de a9 06 f7 0f f5 e1 14 8c 17 c7 ba c0 6b 27
 [553] a6 e9 f1 86 21 7a 18 fc 99 81 59 cb fb 80 0a 52 2c ba 0f 69 f7 cc 36 84
 [577] a9 bb 23 5b 32 d9 c3 28 c3 f6 46 ba d6 b7 5f 77 e2 da e7 b0 ea 68 32 44
 [601] 7f 63 7b 40 83 fa 63 ee 37 4a a3 d5 bb e1 53 5d 99 c0 e4 6a ec 00 96 03
 [625] e2 96 51 de 85 5d c3 62 7b a2 ac cd 1c 9a 18 77 c7 ab 8d 39 9e 56 ee f0
 [649] 2f 5d b0 c7 70 0c cb 3d 5a 5a bf 47 99 3e 11 ba 91 02 81 81 00 bc f4 ec
 [673] 4f 9c 56 40 52 2a 82 d0 99 7a fe 09 b1 91 27 c5 42 f0 e5 df 58 ac 6c 85
 [697] 1a ea fa 49 b4 4e 4d 5a f1 f7 d5 cc 89 05 46 7a 04 36 66 d0 e1 71 94 89
 [721] f0 2e df d8 ca ba 00 8a 5e 7d a8 41 89 e6 98 4a 98 4a 5b 66 e0 24 44 85
 [745] eb 4e 83 29 13 b1 4e 94 1b a4 fb a2 9d 7d ff 59 f7 f8 3a 55 c9 b3 ea 4b
 [769] 42 95 59 09 78 1c b9 07 41 16 94 5c da 36 22 82 34 f6 86 5d cb 69 c4 86
 [793] b0 20 e2 05 cb 02 81 80 1c cd c4 e6 e5 1b ab b8 5a bf 20 c9 59 e7 02 c4
 [817] 26 f3 65 a4 a3 04 e4 78 7f 31 3c a0 16 5a 3f 73 25 c6 a4 b0 b7 ac 3d d1
 [841] 2f 32 4d b3 f0 53 bc cc 4c e9 ad 75 e5 56 e6 4d 64 80 20 74 d2 71 de 46
 [865] 94 79 f7 48 9b 75 9d f5 6d 24 70 9b d3 74 53 61 76 80 96 0c 5d af 0a 65
 [889] 9f 88 8b be b8 f8 73 9f 06 d6 4f da 69 5c cc f1 f9 91 55 68 d4 5a 28 9c
 [913] 18 04 ac 68 24 5f 8e 5a 47 ef 02 b6 22 3f 6c e1 02 81 80 36 78 f1 0a fe
 [937] 49 cb 1f 24 cc 33 70 9b 89 52 a8 12 ed 81 2b 8c 20 e8 a3 3a 89 ca 51 79
 [961] 3e 10 33 5f 83 63 5d 70 11 fd 75 de c4 73 76 75 6c 6c 79 21 72 2d d5 c4
 [985] dd 99 34 d0 2c 49 b7 75 c8 24 a4 a9 8a 6b ae bd 78 de 0e 6d c6 27 49 2f
[1009] 88 16 36 6c 1d f8 0a 84 24 5a bb c6 4f ef d2 d1 87 97 a5 9f 2d 42 e6 fe
[1033] 00 fd fe d7 60 eb db 72 b3 f0 94 a3 98 8d 2a d1 8a e8 cd 34 3f 88 88 8b
[1057] e2 3c c3 02 81 80 46 ec 0f eb 87 c3 a8 6e ea fc 9a e3 d5 95 aa 59 35 25
[1081] 56 66 a7 a9 86 b6 ff d7 9d 71 76 34 ab 67 a4 8d eb 6e 56 61 a8 ba 9f 70
[1105] f7 66 fd d7 63 e2 f2 23 af 23 15 5f f8 eb f2 19 a4 47 37 3c 42 97 35 14
[1129] 53 a2 26 54 00 fa 2c 08 ec c9 52 78 8a b5 c5 8e b9 bc e6 3e ba 8f 78 02
[1153] 8b 8f 35 51 81 5f 8e 4b 2c f6 d9 92 d8 d7 37 21 7b 3d d7 6b 67 fb 68 7d
[1177] bc 03 d2 8b 08 ed 8a 65 e5 88 dd b6 15 e7
attr(,"class")
[1] "private.key.DER"
> PKI.load.key(file=fn.priv.pem)
<pointer: 0x559b773bcb10>
attr(,"class")
[1] "private.key"
> PKI.load.key(file=fn.priv.der, format="DER", private=TRUE)
<pointer: 0x559b773b6380>
attr(,"class")
[1] "private.key"
> fn.pub.pem <- tempfile()
> PKI.save.key(key, target=fn.pub.pem, private=FALSE)
[1] "-----BEGIN PUBLIC KEY-----"                                      
[2] "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApFknwSPCtZLUaxcgR82G"
[3] "cUVnKMjuukO55XankPurINXqHPJov5KBJSI39sJckHZTmiT3mil3QXl/gEAxmSxr"
[4] "cFnu9AbmdIzCLbl/L6R2r69X0BX6qyciGj6nahNlFEHCQAJwgTq9NpuGvlSrTVEQ"
[5] "VIOdbw2CfEMloHO4OrwKyn/h+3LN1eFikBrd+vbWxB66JqZMoSA/ZyXLvZzssOTv"
[6] "Ufj3t6iyWesnFYGODEwGB/T6DmW8jTIljoDTXtEt0KsHCymzNk3tm1ejNPEdFp0m"
[7] "gNbxG0oJj/zAJ6iX1SpE0eGkIkREHGXubLWJ76cGOzlBL/rxtGf4SSdS+vFjZLXF"
[8] "+wIDAQAB"                                                        
[9] "-----END PUBLIC KEY-----"                                        
> fn.pub.der <- tempfile()
> PKI.save.key(key, "DER", target=fn.pub.der, private=FALSE)
  [1] 30 82 01 22 30 0d 06 09 2a 86 48 86 f7 0d 01 01 01 05 00 03 82 01 0f 00 30
 [26] 82 01 0a 02 82 01 01 00 a4 59 27 c1 23 c2 b5 92 d4 6b 17 20 47 cd 86 71 45
 [51] 67 28 c8 ee ba 43 b9 e5 76 a7 90 fb ab 20 d5 ea 1c f2 68 bf 92 81 25 22 37
 [76] f6 c2 5c 90 76 53 9a 24 f7 9a 29 77 41 79 7f 80 40 31 99 2c 6b 70 59 ee f4
[101] 06 e6 74 8c c2 2d b9 7f 2f a4 76 af af 57 d0 15 fa ab 27 22 1a 3e a7 6a 13
[126] 65 14 41 c2 40 02 70 81 3a bd 36 9b 86 be 54 ab 4d 51 10 54 83 9d 6f 0d 82
[151] 7c 43 25 a0 73 b8 3a bc 0a ca 7f e1 fb 72 cd d5 e1 62 90 1a dd fa f6 d6 c4
[176] 1e ba 26 a6 4c a1 20 3f 67 25 cb bd 9c ec b0 e4 ef 51 f8 f7 b7 a8 b2 59 eb
[201] 27 15 81 8e 0c 4c 06 07 f4 fa 0e 65 bc 8d 32 25 8e 80 d3 5e d1 2d d0 ab 07
[226] 0b 29 b3 36 4d ed 9b 57 a3 34 f1 1d 16 9d 26 80 d6 f1 1b 4a 09 8f fc c0 27
[251] a8 97 d5 2a 44 d1 e1 a4 22 44 44 1c 65 ee 6c b5 89 ef a7 06 3b 39 41 2f fa
[276] f1 b4 67 f8 49 27 52 fa f1 63 64 b5 c5 fb 02 03 01 00 01
attr(,"class")
[1] "public.key.DER"
> PKI.load.key(file=fn.pub.pem)
<pointer: 0x559b77322e10>
attr(,"class")
[1] "public.key"
> PKI.load.key(file=fn.pub.der, format="DER", private=FALSE)
<pointer: 0x559b77324820>
attr(,"class")
[1] "public.key"
> 
> info("gmp")
 -- gmp
> if (requireNamespace("gmp", quietly=TRUE)) {
+     PKI.mkRSApubkey(gmp::as.bigz("119445732379544598056145200053932732877863846799652384989588303737527328743970559883211146487286317168142202446955508902936035124709397221178664495721428029984726868375359168203283442617134197706515425366188396513684446494070223079865755643116690165578452542158755074958452695530623055205290232290667934914919"))
+ } else {
+     warn("gmp not found, skipping bignum tests")
+ }
  [1] 30 81 9f 30 0d 06 09 2a 86 48 86 f7 0d 01 01 01 05 00 03 81 8d 00 30 81 89
 [26] 02 81 81 00 aa 18 ab a4 3b 50 de ef 38 59 8f af 87 d2 ab 63 4e 45 71 c1 30
 [51] a9 bc a7 b8 78 26 74 14 fa ab 8b 47 1b d8 96 5f 5c 9f c3 81 84 85 ea f5 29
 [76] c2 62 46 f3 05 50 64 a8 de 19 c8 c3 38 be 54 96 cb ae b0 59 dc 0b 35 81 43
[101] b4 4a 35 44 9e b2 64 11 31 21 a4 55 bd 7f de 3f ac 91 9e 94 b5 6f b9 bb 4f
[126] 65 1c db 23 ea d4 39 d6 cd 52 3e b0 81 91 e7 5b 35 fd 13 a7 41 9b 30 90 f2
[151] 47 87 bd 4f 4e 19 67 02 03 01 00 01
> 
> info("Ciphers")
 -- Ciphers
> skey <- PKI.random(256)
> for (cipher in c("aes256ecb", "aes256ofb", "bfcbc", "bfecb", "bfofb", "bfcfb"))
+     assert(cipher, all(PKI.decrypt(PKI.encrypt(charToRaw("foo!"), skey, cipher), skey, cipher)[1:4] == charToRaw("foo!")))
   .  aes256ecb 
   .  aes256ofb 
   .  bfcbc 
   .  bfecb 
   .  bfofb 
   .  bfcfb 
> iv <- PKI.random(256)
> for (cipher in c("bfcbc", "bfecb", "bfofb", "bfcfb"))
+     assert(paste0(cipher, " (with IV)"),
+                   all(PKI.decrypt(PKI.encrypt(charToRaw("foo!"), skey, cipher, iv=iv), skey, cipher, iv=iv)[1:4] == charToRaw("foo!")))
   .  bfcbc (with IV) 
   .  bfecb (with IV) 
   .  bfofb (with IV) 
   .  bfcfb (with IV) 
> 
> info("ASN.1")
 -- ASN.1
> 
> assert("ASN.1 encode/decode", 
+ { d <- ASN1.decode(ASN1.encode(ASN1.item(0:255, 3L)))
+   ASN1.type(d) == 3L && all(d == as.raw(0:255)) })
   .  ASN.1 encode/decode 
> 
> info("Tar ball signing")
 -- Tar ball signing
> tmpfn <- c(fn.pub.der, fn.pub.pem, fn.priv.der, fn.priv.pem)
> fn <- tempfile()
> ## on some systems using abs paths can break 100 byte limit
> ## so we must do this in the tempdir
> wd <- getwd()
> td <- tempdir()
> setwd(td)
> tar(fn, basename(tmpfn), "none")
> PKI.sign.tar(fn, key)
> PKI.verify.tar(fn, key)
[1] TRUE
> setwd(wd)
> 
> unlink(c(fn, tmpfn))
> 
