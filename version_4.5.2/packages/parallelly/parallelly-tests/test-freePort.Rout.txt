
R version 4.5.2 (2025-10-31) -- "[Not] Part in a Rumble"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> #! /usr/bin/env Rscript
> ## This runs testme test script inst/testme/test-freePort.R
> ## Don't edit - it was autogenerated by inst/testme/deploy.R
> parallelly:::testme("freePort")
Test ‘freePort’ ...

> library(parallelly)

> message("*** initialize_internet() ...")
*** initialize_internet() ...

> initialize_internet <- parallelly:::initialize_internet

> environment(initialize_internet)$done <- FALSE

> message("*** initialize_internet() ... DONE")
*** initialize_internet() ... DONE

> message("*** freePort() ...")
*** freePort() ...

> oenv <- Sys.getenv("R_PARALLELLY_RANDOM_PORTS")

> Sys.setenv(R_PARALLELLY_DEBUG = "TRUE")

> set.seed(42)

> rng <- .Random.seed

> for (kk in 1:5) {
+     port <- freePort()
+     message("A random free TCP port: ", port)
+     stopifnot(is.integer(port), length(port) == 1)
+    .... [TRUNCATED] 
parallelly:::isTcpPortAvailable(33893): available (can bind and listen)
A random free TCP port: 33893
parallelly:::isTcpPortAvailable(38882): available (can bind and listen)
A random free TCP port: 38882
parallelly:::isTcpPortAvailable(2251): available (can bind and listen)
A random free TCP port: 2251
parallelly:::isTcpPortAvailable(37842): available (can bind and listen)
A random free TCP port: 37842
parallelly:::isTcpPortAvailable(44819): available (can bind and listen)
A random free TCP port: 44819

> port <- freePort(default = 1024)
parallelly:::isTcpPortAvailable(29948): available (can bind and listen)

> stopifnot(is.integer(port), length(port) == 1)

> port <- tryCatch(freePort(default = -1), error = identity)

> stopifnot(inherits(port, "error"))

> port <- freePort(ports = integer(0), default = 1024)

> stopifnot(is.integer(port), length(port) == 1, port == 
+     1024)

> message("- freePort('auto')")
- freePort('auto')

> Sys.unsetenv("R_PARALLEL_PORT")

> port <- freePort("auto")
parallelly:::isTcpPortAvailable(11799): available (can bind and listen)

> message("A random free TCP port: ", port)
A random free TCP port: 11799

> message("- freePort('auto') with env var R_PARALLEL_PORT = 8888")
- freePort('auto') with env var R_PARALLEL_PORT = 8888

> Sys.setenv(R_PARALLEL_PORT = 8888)

> port <- freePort("auto")
parallelly:::isTcpPortAvailable(8888): available (can bind and listen)

> message("A free TCP port: ", port)
A free TCP port: 8888

> stopifnot(port == 8888)

> Sys.setenv(R_PARALLEL_PORT = "invalid")

> cond <- NULL

> withCallingHandlers({
+     port <- freePort("auto")
+ }, warning = function(c) {
+     cond <<- c
+ })
Warning in freePort("auto") :
  Will use a random port because environment variable 'R_PARALLEL_PORT' coerced to NA_integer_: ‘invalid’
parallelly:::isTcpPortAvailable(11072): available (can bind and listen)

> stopifnot(is.integer(port), length(port) == 1)

> stopifnot(inherits(cond, "warning"))

> Sys.unsetenv("R_PARALLEL_PORT")

> port <- freePort()
parallelly:::isTcpPortAvailable(15725): available (can bind and listen)

> message("A free TCP port: ", port)
A free TCP port: 15725

> Sys.unsetenv("R_PARALLELLY_RANDOM_PORTS")

> port <- freePort("random")
parallelly:::isTcpPortAvailable(11311): available (can bind and listen)

> message("A free TCP port: ", port)
A free TCP port: 11311

> stopifnot(is.integer(port), length(port) == 1, port %in% 
+     11000:11999)

> Sys.setenv(R_PARALLELLY_RANDOM_PORTS = "30000:50000")

> port <- freePort("random")
parallelly:::isTcpPortAvailable(48031): available (can bind and listen)

> message("A free TCP port: ", port)
A free TCP port: 48031

> stopifnot(is.integer(port), length(port) == 1, port %in% 
+     30000:50000)

> Sys.setenv(R_PARALLELLY_RANDOM_PORTS = "invalid:50000")

> cond <- NULL

> withCallingHandlers({
+     port <- freePort("random")
+ }, warning = function(c) {
+     cond <<- c
+ })
Warning in randomParallelPorts() :
  Skipping unknown port specification in environment variable 'R_PARALLELLY_RANDOM_PORTS': ‘invalid:50000’
Warning in randomParallelPorts() :
  Will use the default set of random ports, because environment variable 'R_PARALLELLY_RANDOM_PORTS' did not specify any valid ports: ‘invalid:50000’
parallelly:::isTcpPortAvailable(11732): available (can bind and listen)

> stopifnot(is.integer(port), length(port) == 1)

> stopifnot(inherits(cond, "warning"))

> Sys.setenv(R_PARALLELLY_RANDOM_PORTS = "99999:99999")

> cond <- NULL

> withCallingHandlers({
+     port <- freePort("random")
+ }, warning = function(c) {
+     cond <<- c
+ })
Warning in randomParallelPorts() :
  Skipping port specification in environment variable 'R_PARALLELLY_RANDOM_PORTS' that specify ports outside of [0,65535]: ‘99999:99999’
Warning in randomParallelPorts() :
  Will use the default set of random ports, because environment variable 'R_PARALLELLY_RANDOM_PORTS' did not specify any valid ports: ‘99999:99999’
parallelly:::isTcpPortAvailable(11223): available (can bind and listen)

> stopifnot(is.integer(port), length(port) == 1)

> stopifnot(inherits(cond, "warning"))

> isPortFree <- function(port) !is.na(freePort(port, 
+     default = NA))

> Sys.setenv(R_PARALLELLY_DEBUG = "true")

> Sys.unsetenv("_R_PARALLELLY_CHECK_AVAILABLE_PORTS_")

> free <- isPortFree(1024)
parallelly:::isTcpPortAvailable(1024): available (can bind and listen)

> message("TCP port 1024 is free: ", free)
TCP port 1024 is free: TRUE

> stopifnot(is.logical(free), length(free) == 1, !is.na(free))

> Sys.setenv(`_R_PARALLELLY_CHECK_AVAILABLE_PORTS_` = "any")

> free <- isPortFree(1)

> message("TCP port 1 is free: ", free)
TCP port 1 is free: TRUE

> stopifnot(is.logical(free), length(free) == 1, !is.na(free), 
+     isTRUE(free))

> Sys.setenv(`_R_PARALLELLY_CHECK_AVAILABLE_PORTS_` = "invalid")

> free <- tryCatch(isPortFree(1), error = identity)

> stopifnot(inherits(free, "error"))

> Sys.unsetenv("R_PARALLELLY_DEBUG")

> Sys.setenv(R_PARALLELLY_RANDOM_PORTS = oenv)

> message("*** freePort() ... DONE")
*** freePort() ... DONE
Test time: user.self=0.08s, sys.self=0.005s, elapsed=0.09s, user.child=0s, sys.child=0s
Test ‘freePort’ ... success
> 
