
R version 4.5.1 (2025-06-13) -- "Great Square Root"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> ## simple test suite - avoid testthat! It has an insane amount of
> ## unnecessary dependencies. A test package should have exactly 0
> 
> assert <- function(msg, what) {
+     cat("   . ", msg,"\n")
+     stopifnot(what)
+     .GlobalEnv$ok <- .GlobalEnv$ok + 1L
+ }
> 
> xfail <- function(...) suppressWarnings(tryCatch({ ...; FALSE }, error=function(e) TRUE))
> 
> ## none of these are fatal
> info <- function(...) message(" -- ", ...)
> err  <- function(...) message(" ** ERROR: ", ...)
> warn <- function(...) message(" !! ", ...)
> 
> ## all warnings (unless suppressed) are errors
> options(warn=2)
> 
> library(PKI)
Loading required package: base64enc
> 
> .GlobalEnv$ok <- 0L
> 
> ## Majority of tests are in th3 examples,
> ## so we won't repeat those, but some special cases
> ## not covered there as well as expected failures
> 
> info("Checking failure paths")
 -- Checking failure paths
> xfail(PKI.load.cert(what="foo", file="bar")) ## set both what and file
[1] TRUE
> xfail(PKI.load.cert("foo", "DER")) ## binary format with text
[1] TRUE
> xfail(PKI.load.cert("nothing")) ## invalid content
[1] TRUE
> xfail(PKI.digest("foo", "bar")) ## invalid hash spec
[1] TRUE
> xfail(PKI.load.key(what="foo", file="bar"))
[1] TRUE
> xfail(PKI:::PKI.decode.SSH2(fn.priv.der)) ## try to load invalid content
[1] TRUE
> 
> info("Checking key paths via files/connections")
 -- Checking key paths via files/connections
> key <- PKI.genRSAkey(bits = 2048L)
> fn.priv.pem <- tempfile()
> PKI.save.key(key, target=fn.priv.pem)
 [1] "-----BEGIN RSA PRIVATE KEY-----"                                 
 [2] "MIIEowIBAAKCAQEApvVQ2uOkEDFfgXxugqFnT1CEpMrzkoOcG2aAVZTJdSM2O6OL"
 [3] "lGSDSmIUHz1ITrBRTv7/lq5abfvWqVMYYVPOCl3RZYkp5hYogYgEvx7oJ1/Q37lZ"
 [4] "rQloYMJTxOs3e26R3LmC0wDZJ+GWTZDlNcYR/oYOa2s3GyjR4GRnH1sfOCY0CiKg"
 [5] "K7uPg3xsLHK049TUxjziZzJBtEvLmRs1vwhmZ1lFcCJs/EyI0bTy/ZStTk+hrYw8"
 [6] "OpkvOrmprNtEhZGx05MUa7p9NDD0swfPrKcS4GwdQ/V/bj2O3xkLFiEKKiluB072"
 [7] "rSiKf/HIIVaEN0SSrorNebuxKMfavhzIZ29mQwIDAQABAoIBABLGf6M9+lM/2ier"
 [8] "oJncIMwQl/oYQK/3UPTb4A6/vrAHl6+5QpcbfpA821pv/9OpjFs/3epKDS1VJty/"
 [9] "1XwMep0707KBbE7Nqxx1+WKszRqwccLXCzikWDKZZ+Y7NXASDSEvU4D7FXCgs9Bh"
[10] "PQWBEsD2vmRiGD5bps5/PAGQs8ASjQkRhk0nJTPTPBxYAStTvfA/yzDgKRiDOu9p"
[11] "aK9KNVWczUBYnqWx5ut9ObbTtkiQDVM8XHjf728qf1+pK/H3DVXA9p687cV/aeFN"
[12] "Hr6FnKE6elwt/I/FW5Fh7y0DZIDiAg4DDyIkqR7qSklEPBFy38PhOw2jiXWhCzsd"
[13] "IiIlHPECgYEA5FkITj2+a4KOg6/uOHeC+6rYmxAfZay+vlNOEk/1lMmmDAEE7d0/"
[14] "oSocCwgzjR1RL4TwaOKsm818IGDlImjXUPq9DpXbmaWgbwEktZwJA120l1B9GOKl"
[15] "3JVOUGQBbkTLjXj+tE4MRzXAoZA+FfE7lrPEHv5o82TlC6MUOcHRsucCgYEAuy0o"
[16] "g5Pnhdq0hwiRE8D5FwF9B5y0uj5IXUffnULtsx/iOeFmMrFEddApx8qsvawVpzCK"
[17] "DRmqAxj5gXDmp6pGYuc0xJzZzMFyC9F2K4O33R11nBbjberoyrddXOCUZ/3fRM03"
[18] "I/iUICb9oYuomxffrSxpxEPvOIyR2HqLDLEsokUCgYBJyFrerSSyKGVUN6yJolQ4"
[19] "bWO/9t2uRLr9VH2NfTik8uMsTcgB89Nzh9+30NaXajmpWRM1UMjlLuhErgpbq/Sm"
[20] "vd4IsHNcmh/UvlHWPKzM4aJQojlJqTJeq/+6ChZMQv5ioA3sxKtC9yNfEPR+sovG"
[21] "jh94xEu1GYzIzdDjOLVBUQKBgBjoVHjV6Lw+M0G42R1o03zFPO8TYlVaTmTjWJVj"
[22] "v5/TgVY0cVYTksmersCgbsY6rRL3eZdur9oDq8gWzwrGtOEaZUI4oR8HKvb5o6D8"
[23] "wS3SasEfppoM5Xd8WRcv52/DL7/HEyxdOtDgf2XM4N3qmmBABb8RTzcWNZ46CGDi"
[24] "/s6FAoGBAJxnhD8hW6ZM9Q1/ynvMBQ6MWUcQUULIcBs300zsxRMtv14vgt8wECDT"
[25] "Clg1eRiNDk2Lgci83BApmyuqA64mZ5iaKXyI+fpEHcibQQVAbnPylJhI9tO1JGiK"
[26] "NBx3KlFTnz1L9meiJCF4lSM1iYSqScg59Fwj4uaCalCiK9C74i4i"            
[27] "-----END RSA PRIVATE KEY-----"                                   
> fn.priv.der <- tempfile()
> PKI.save.key(key, "DER", target=fn.priv.der)
   [1] 30 82 04 a3 02 01 00 02 82 01 01 00 a6 f5 50 da e3 a4 10 31 5f 81 7c 6e
  [25] 82 a1 67 4f 50 84 a4 ca f3 92 83 9c 1b 66 80 55 94 c9 75 23 36 3b a3 8b
  [49] 94 64 83 4a 62 14 1f 3d 48 4e b0 51 4e fe ff 96 ae 5a 6d fb d6 a9 53 18
  [73] 61 53 ce 0a 5d d1 65 89 29 e6 16 28 81 88 04 bf 1e e8 27 5f d0 df b9 59
  [97] ad 09 68 60 c2 53 c4 eb 37 7b 6e 91 dc b9 82 d3 00 d9 27 e1 96 4d 90 e5
 [121] 35 c6 11 fe 86 0e 6b 6b 37 1b 28 d1 e0 64 67 1f 5b 1f 38 26 34 0a 22 a0
 [145] 2b bb 8f 83 7c 6c 2c 72 b4 e3 d4 d4 c6 3c e2 67 32 41 b4 4b cb 99 1b 35
 [169] bf 08 66 67 59 45 70 22 6c fc 4c 88 d1 b4 f2 fd 94 ad 4e 4f a1 ad 8c 3c
 [193] 3a 99 2f 3a b9 a9 ac db 44 85 91 b1 d3 93 14 6b ba 7d 34 30 f4 b3 07 cf
 [217] ac a7 12 e0 6c 1d 43 f5 7f 6e 3d 8e df 19 0b 16 21 0a 2a 29 6e 07 4e f6
 [241] ad 28 8a 7f f1 c8 21 56 84 37 44 92 ae 8a cd 79 bb b1 28 c7 da be 1c c8
 [265] 67 6f 66 43 02 03 01 00 01 02 82 01 00 12 c6 7f a3 3d fa 53 3f da 27 ab
 [289] a0 99 dc 20 cc 10 97 fa 18 40 af f7 50 f4 db e0 0e bf be b0 07 97 af b9
 [313] 42 97 1b 7e 90 3c db 5a 6f ff d3 a9 8c 5b 3f dd ea 4a 0d 2d 55 26 dc bf
 [337] d5 7c 0c 7a 9d 3b d3 b2 81 6c 4e cd ab 1c 75 f9 62 ac cd 1a b0 71 c2 d7
 [361] 0b 38 a4 58 32 99 67 e6 3b 35 70 12 0d 21 2f 53 80 fb 15 70 a0 b3 d0 61
 [385] 3d 05 81 12 c0 f6 be 64 62 18 3e 5b a6 ce 7f 3c 01 90 b3 c0 12 8d 09 11
 [409] 86 4d 27 25 33 d3 3c 1c 58 01 2b 53 bd f0 3f cb 30 e0 29 18 83 3a ef 69
 [433] 68 af 4a 35 55 9c cd 40 58 9e a5 b1 e6 eb 7d 39 b6 d3 b6 48 90 0d 53 3c
 [457] 5c 78 df ef 6f 2a 7f 5f a9 2b f1 f7 0d 55 c0 f6 9e bc ed c5 7f 69 e1 4d
 [481] 1e be 85 9c a1 3a 7a 5c 2d fc 8f c5 5b 91 61 ef 2d 03 64 80 e2 02 0e 03
 [505] 0f 22 24 a9 1e ea 4a 49 44 3c 11 72 df c3 e1 3b 0d a3 89 75 a1 0b 3b 1d
 [529] 22 22 25 1c f1 02 81 81 00 e4 59 08 4e 3d be 6b 82 8e 83 af ee 38 77 82
 [553] fb aa d8 9b 10 1f 65 ac be be 53 4e 12 4f f5 94 c9 a6 0c 01 04 ed dd 3f
 [577] a1 2a 1c 0b 08 33 8d 1d 51 2f 84 f0 68 e2 ac 9b cd 7c 20 60 e5 22 68 d7
 [601] 50 fa bd 0e 95 db 99 a5 a0 6f 01 24 b5 9c 09 03 5d b4 97 50 7d 18 e2 a5
 [625] dc 95 4e 50 64 01 6e 44 cb 8d 78 fe b4 4e 0c 47 35 c0 a1 90 3e 15 f1 3b
 [649] 96 b3 c4 1e fe 68 f3 64 e5 0b a3 14 39 c1 d1 b2 e7 02 81 81 00 bb 2d 28
 [673] 83 93 e7 85 da b4 87 08 91 13 c0 f9 17 01 7d 07 9c b4 ba 3e 48 5d 47 df
 [697] 9d 42 ed b3 1f e2 39 e1 66 32 b1 44 75 d0 29 c7 ca ac bd ac 15 a7 30 8a
 [721] 0d 19 aa 03 18 f9 81 70 e6 a7 aa 46 62 e7 34 c4 9c d9 cc c1 72 0b d1 76
 [745] 2b 83 b7 dd 1d 75 9c 16 e3 6d ea e8 ca b7 5d 5c e0 94 67 fd df 44 cd 37
 [769] 23 f8 94 20 26 fd a1 8b a8 9b 17 df ad 2c 69 c4 43 ef 38 8c 91 d8 7a 8b
 [793] 0c b1 2c a2 45 02 81 80 49 c8 5a de ad 24 b2 28 65 54 37 ac 89 a2 54 38
 [817] 6d 63 bf f6 dd ae 44 ba fd 54 7d 8d 7d 38 a4 f2 e3 2c 4d c8 01 f3 d3 73
 [841] 87 df b7 d0 d6 97 6a 39 a9 59 13 35 50 c8 e5 2e e8 44 ae 0a 5b ab f4 a6
 [865] bd de 08 b0 73 5c 9a 1f d4 be 51 d6 3c ac cc e1 a2 50 a2 39 49 a9 32 5e
 [889] ab ff ba 0a 16 4c 42 fe 62 a0 0d ec c4 ab 42 f7 23 5f 10 f4 7e b2 8b c6
 [913] 8e 1f 78 c4 4b b5 19 8c c8 cd d0 e3 38 b5 41 51 02 81 80 18 e8 54 78 d5
 [937] e8 bc 3e 33 41 b8 d9 1d 68 d3 7c c5 3c ef 13 62 55 5a 4e 64 e3 58 95 63
 [961] bf 9f d3 81 56 34 71 56 13 92 c9 9e ae c0 a0 6e c6 3a ad 12 f7 79 97 6e
 [985] af da 03 ab c8 16 cf 0a c6 b4 e1 1a 65 42 38 a1 1f 07 2a f6 f9 a3 a0 fc
[1009] c1 2d d2 6a c1 1f a6 9a 0c e5 77 7c 59 17 2f e7 6f c3 2f bf c7 13 2c 5d
[1033] 3a d0 e0 7f 65 cc e0 dd ea 9a 60 40 05 bf 11 4f 37 16 35 9e 3a 08 60 e2
[1057] fe ce 85 02 81 81 00 9c 67 84 3f 21 5b a6 4c f5 0d 7f ca 7b cc 05 0e 8c
[1081] 59 47 10 51 42 c8 70 1b 37 d3 4c ec c5 13 2d bf 5e 2f 82 df 30 10 20 d3
[1105] 0a 58 35 79 18 8d 0e 4d 8b 81 c8 bc dc 10 29 9b 2b aa 03 ae 26 67 98 9a
[1129] 29 7c 88 f9 fa 44 1d c8 9b 41 05 40 6e 73 f2 94 98 48 f6 d3 b5 24 68 8a
[1153] 34 1c 77 2a 51 53 9f 3d 4b f6 67 a2 24 21 78 95 23 35 89 84 aa 49 c8 39
[1177] f4 5c 23 e2 e6 82 6a 50 a2 2b d0 bb e2 2e 22
attr(,"class")
[1] "private.key.DER"
> PKI.load.key(file=fn.priv.pem)
<pointer: 0x55752d080880>
attr(,"class")
[1] "private.key"
> PKI.load.key(file=fn.priv.der, format="DER", private=TRUE)
<pointer: 0x55752d07a0f0>
attr(,"class")
[1] "private.key"
> fn.pub.pem <- tempfile()
> PKI.save.key(key, target=fn.pub.pem, private=FALSE)
[1] "-----BEGIN PUBLIC KEY-----"                                      
[2] "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApvVQ2uOkEDFfgXxugqFn"
[3] "T1CEpMrzkoOcG2aAVZTJdSM2O6OLlGSDSmIUHz1ITrBRTv7/lq5abfvWqVMYYVPO"
[4] "Cl3RZYkp5hYogYgEvx7oJ1/Q37lZrQloYMJTxOs3e26R3LmC0wDZJ+GWTZDlNcYR"
[5] "/oYOa2s3GyjR4GRnH1sfOCY0CiKgK7uPg3xsLHK049TUxjziZzJBtEvLmRs1vwhm"
[6] "Z1lFcCJs/EyI0bTy/ZStTk+hrYw8OpkvOrmprNtEhZGx05MUa7p9NDD0swfPrKcS"
[7] "4GwdQ/V/bj2O3xkLFiEKKiluB072rSiKf/HIIVaEN0SSrorNebuxKMfavhzIZ29m"
[8] "QwIDAQAB"                                                        
[9] "-----END PUBLIC KEY-----"                                        
> fn.pub.der <- tempfile()
> PKI.save.key(key, "DER", target=fn.pub.der, private=FALSE)
  [1] 30 82 01 22 30 0d 06 09 2a 86 48 86 f7 0d 01 01 01 05 00 03 82 01 0f 00 30
 [26] 82 01 0a 02 82 01 01 00 a6 f5 50 da e3 a4 10 31 5f 81 7c 6e 82 a1 67 4f 50
 [51] 84 a4 ca f3 92 83 9c 1b 66 80 55 94 c9 75 23 36 3b a3 8b 94 64 83 4a 62 14
 [76] 1f 3d 48 4e b0 51 4e fe ff 96 ae 5a 6d fb d6 a9 53 18 61 53 ce 0a 5d d1 65
[101] 89 29 e6 16 28 81 88 04 bf 1e e8 27 5f d0 df b9 59 ad 09 68 60 c2 53 c4 eb
[126] 37 7b 6e 91 dc b9 82 d3 00 d9 27 e1 96 4d 90 e5 35 c6 11 fe 86 0e 6b 6b 37
[151] 1b 28 d1 e0 64 67 1f 5b 1f 38 26 34 0a 22 a0 2b bb 8f 83 7c 6c 2c 72 b4 e3
[176] d4 d4 c6 3c e2 67 32 41 b4 4b cb 99 1b 35 bf 08 66 67 59 45 70 22 6c fc 4c
[201] 88 d1 b4 f2 fd 94 ad 4e 4f a1 ad 8c 3c 3a 99 2f 3a b9 a9 ac db 44 85 91 b1
[226] d3 93 14 6b ba 7d 34 30 f4 b3 07 cf ac a7 12 e0 6c 1d 43 f5 7f 6e 3d 8e df
[251] 19 0b 16 21 0a 2a 29 6e 07 4e f6 ad 28 8a 7f f1 c8 21 56 84 37 44 92 ae 8a
[276] cd 79 bb b1 28 c7 da be 1c c8 67 6f 66 43 02 03 01 00 01
attr(,"class")
[1] "public.key.DER"
> PKI.load.key(file=fn.pub.pem)
<pointer: 0x55752cfe6c30>
attr(,"class")
[1] "public.key"
> PKI.load.key(file=fn.pub.der, format="DER", private=FALSE)
<pointer: 0x55752cfe8640>
attr(,"class")
[1] "public.key"
> 
> info("gmp")
 -- gmp
> if (requireNamespace("gmp", quietly=TRUE)) {
+     PKI.mkRSApubkey(gmp::as.bigz("119445732379544598056145200053932732877863846799652384989588303737527328743970559883211146487286317168142202446955508902936035124709397221178664495721428029984726868375359168203283442617134197706515425366188396513684446494070223079865755643116690165578452542158755074958452695530623055205290232290667934914919"))
+ } else {
+     warn("gmp not found, skipping bignum tests")
+ }
  [1] 30 81 9f 30 0d 06 09 2a 86 48 86 f7 0d 01 01 01 05 00 03 81 8d 00 30 81 89
 [26] 02 81 81 00 aa 18 ab a4 3b 50 de ef 38 59 8f af 87 d2 ab 63 4e 45 71 c1 30
 [51] a9 bc a7 b8 78 26 74 14 fa ab 8b 47 1b d8 96 5f 5c 9f c3 81 84 85 ea f5 29
 [76] c2 62 46 f3 05 50 64 a8 de 19 c8 c3 38 be 54 96 cb ae b0 59 dc 0b 35 81 43
[101] b4 4a 35 44 9e b2 64 11 31 21 a4 55 bd 7f de 3f ac 91 9e 94 b5 6f b9 bb 4f
[126] 65 1c db 23 ea d4 39 d6 cd 52 3e b0 81 91 e7 5b 35 fd 13 a7 41 9b 30 90 f2
[151] 47 87 bd 4f 4e 19 67 02 03 01 00 01
> 
> info("Ciphers")
 -- Ciphers
> skey <- PKI.random(256)
> for (cipher in c("aes256ecb", "aes256ofb", "bfcbc", "bfecb", "bfofb", "bfcfb"))
+     assert(cipher, all(PKI.decrypt(PKI.encrypt(charToRaw("foo!"), skey, cipher), skey, cipher)[1:4] == charToRaw("foo!")))
   .  aes256ecb 
   .  aes256ofb 
   .  bfcbc 
   .  bfecb 
   .  bfofb 
   .  bfcfb 
> iv <- PKI.random(256)
> for (cipher in c("bfcbc", "bfecb", "bfofb", "bfcfb"))
+     assert(paste0(cipher, " (with IV)"),
+                   all(PKI.decrypt(PKI.encrypt(charToRaw("foo!"), skey, cipher, iv=iv), skey, cipher, iv=iv)[1:4] == charToRaw("foo!")))
   .  bfcbc (with IV) 
   .  bfecb (with IV) 
   .  bfofb (with IV) 
   .  bfcfb (with IV) 
> 
> info("ASN.1")
 -- ASN.1
> 
> assert("ASN.1 encode/decode", 
+ { d <- ASN1.decode(ASN1.encode(ASN1.item(0:255, 3L)))
+   ASN1.type(d) == 3L && all(d == as.raw(0:255)) })
   .  ASN.1 encode/decode 
> 
> info("Tar ball signing")
 -- Tar ball signing
> tmpfn <- c(fn.pub.der, fn.pub.pem, fn.priv.der, fn.priv.pem)
> fn <- tempfile()
> ## on some systems using abs paths can break 100 byte limit
> ## so we must do this in the tempdir
> wd <- getwd()
> td <- tempdir()
> setwd(td)
> tar(fn, basename(tmpfn), "none")
> PKI.sign.tar(fn, key)
> PKI.verify.tar(fn, key)
[1] TRUE
> setwd(wd)
> 
> unlink(c(fn, tmpfn))
> 
